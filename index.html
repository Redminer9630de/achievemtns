<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Count Merged PRs</title>
</head>
<body>
  <h1>GitHub PR Z√§hler</h1>
  <p>Token: <input type="password" id="token" size="50"></p>
  <p>Benutzername: <input type="text" id="user" value="Redminer9630"></p>
  <button onclick="countMerged()">Z√§hlen</button>
  <pre id="output">...</pre>

  <script>
    async function countMerged() {
      const token = document.getElementById('token').value;
      const username = document.getElementById('user').value;
      const output = document.getElementById('output');
      output.textContent = 'Lade Repos...';

      const headers = { Authorization: `token ${token}` };
      let repos = [];
      let page = 1;

      while (true) {
        const res = await fetch(`https://api.github.com/users/${username}/repos?per_page=100&page=${page}`, { headers });
        const data = await res.json();
        if (data.length === 0) break;
        repos.push(...data);
        page++;
      }

      let total = 0;
      for (const repo of repos) {
        output.textContent = `Pr√ºfe ${repo.name}...\n${output.textContent}`;
        let prpage = 1;
        while (true) {
          const res = await fetch(`https://api.github.com/repos/${username}/${repo.name}/pulls?state=closed&per_page=100&page=${prpage}`, { headers });
          const prs = await res.json();
          if (prs.length === 0 || prs.message) break;

          for (const pr of prs) {
            if (pr.merged_at && pr.user.login === username) total++;
          }

          prpage++;
        }
      }

      output.textContent = `‚úÖ Gemergte PRs von ${username}: ${total}`;
    }
  </script>
</body>
</html>
    progressBar.value = i;

    try {
      // Datei lesen
      const fileRes = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${file}?ref=${baseBranch}`);
      if (!fileRes.ok) throw new Error(`Datei ${file} konnte nicht gelesen werden (Status: ${fileRes.status})`);
      const fileData = await fileRes.json();

      // SHA vom Haupt-Branch
      const baseRes = await fetch(`https://api.github.com/repos/${user}/${repo}/git/refs/heads/${baseBranch}`);
      if (!baseRes.ok) throw new Error(`Branch ${baseBranch} konnte nicht gelesen werden (Status: ${baseRes.status})`);
      const baseData = await baseRes.json();

      // Branch erstellen
      const createBranchRes = await fetch(`https://api.github.com/repos/${user}/${repo}/git/refs`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/vnd.github.v3+json" },
        body: JSON.stringify({ ref: `refs/heads/${prBranch}`, sha: baseData.object.sha })
      });
      if (!createBranchRes.ok) {
        const errData = await createBranchRes.json();
        throw new Error(`Branch erstellen fehlgeschlagen: ${createBranchRes.status} - ${errData.message}`);
      }

      // Datei ver√§ndern
      const oldContent = decode(fileData.content);
      const newContent = `${oldContent}PR ${i}\n`;

      const updateFileRes = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${file}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "Accept": "application/vnd.github.v3+json" },
        body: JSON.stringify({
          message: `PR ${i}`,
          content: b64(newContent),
          branch: prBranch,
          sha: fileData.sha
        })
      });
      if (!updateFileRes.ok) {
        const errData = await updateFileRes.json();
        throw new Error(`Datei aktualisieren fehlgeschlagen: ${updateFileRes.status} - ${errData.message}`);
      }

      // Pull Request erstellen
      const prRes = await fetch(`https://api.github.com/repos/${user}/${repo}/pulls`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/vnd.github.v3+json" },
        body: JSON.stringify({
          title: `PR ${i}`,
          head: prBranch,
          base: baseBranch,
          body: `Automatisch erstellt (PR ${i})`
        })
      });
      if (!prRes.ok) {
        const errData = await prRes.json();
        throw new Error(`PR erstellen fehlgeschlagen: ${prRes.status} - ${errData.message}`);
      }

      alert(`‚úÖ PR ${i} (${prBranch}) erfolgreich erstellt`);
    } catch (err) {
      alert(`‚ö†Ô∏è Fehler bei PR ${i}: ${err.message}`);
      status.innerText = `‚ö†Ô∏è Fehler bei PR ${i}: ${err.message}`;
      break;
    }

    status.innerText = `‚úÖ PR ${i} erstellt`;
    progressBar.value = i;
    await delay(2000);
  }

  alert("üéâ Alle 100 Pull Requests wurden erstellt!");
  status.innerText = "‚úÖ Alle 100 Pull Requests wurden erstellt!";
}
</script>
</body>
</html>
